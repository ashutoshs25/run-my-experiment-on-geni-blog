This is an experimental demonstration of [frequency hopping spread spectrum](https://en.wikipedia.org/wiki/Frequency-hopping_spread_spectrum), a wireless technology that spreads a signal over rapidly changing frequencies. You will learn how a frequency hopping transmitter works and observe a FHSS signal transmitted over the air using software defined radio devices.

It should take about 60-120 minutes to run this experiment, but you will need to have reserved that time in advance. This experiment uses wireless resources (specifically, any one of the sb2, sb3, or sb7 sandbox at [ORBIT](http://geni.orbit-lab.org)), and you can only use wireless resources on GENI during a reservation.

To reproduce this experiment on GENI, you will need an account on the [GENI Portal](http://groups.geni.net/geni/wiki/SignMeUp), and you will need to have [joined a project](http://groups.geni.net/geni/wiki/JoinAProject). You should have already [uploaded your SSH keys to the portal](http://groups.geni.net/geni/wiki/HowTo/LoginToNodes). The project lead of the project you belong to must have [enabled wireless for the project](https://portal.geni.net/secure/wimax-enable.php). Finally, you must have reserved time on a sandbox at [ORBIT](http://geni.orbit-lab.org) and you must run this experiment during your reserved time. (You may use sb2, sb3, or sb7 on ORBIT.)

* Skip to [Results](#results)
* Skip to [Run my experiment](#runmyexperiment)

## Background

In a frequency-hopping spread spectrum (FHSS) system, the transmitted signal is spread across multiple channels, as shown in Figure 1 below. In the example of Figure 1, the full bandwidth is divided into 8 channels, centered at f<sub>1</sub> through f<sub>8</sub>. The signal "hops" between them in the following sequence: f<sub>5</sub>, f<sub>8</sub>, f<sub>3</sub>, f<sub>6</sub>, f<sub>1</sub>, f<sub>7</sub>, f<sub>4</sub>, f<sub>2</sub>. 

![](/blog/content/images/2017/02/channel-assignments.svg)
<small><i>Figure 1: Frequency hopping example, from William Stallings "Data and Computer Communications". </i></small>

Figure 2 shows the block diagram of a typical FHSS transmitter. First, digital data is modulated using some digital-to-analog scheme. This baseband signal is then modulated onto a carrier _c(t)_.


![](/blog/content/images/2017/02/fhss-tx-1.svg)
<small><i>Figure 1: Block diagram of FHSS transmitter, from William Stallings "Data and Computer Communications". </i></small>

The frequency of the carrier _c(t)_, i.e. the sequence of channels, depends on the _spreading code_, which is generated by a pseudonoise (PN) source. Every _T<sub>C</sub>_ seconds, the PN source produces a new k-bit value. This value is then used to look up a channel in the channel table, and that determines the frequency of _c(t)_ for that time interval.

For example, consider a system where k=4, and for the first time interval, the PN source generates the value 1101<sub>2</sub>. For that time interval, the signal will be transmitted on channel 13. (The channel table will have 2<sup>k</sup>-1=2<sup>4-1</sup>=15 entries, indexed from 1 to 15. The PN sequence will repeat itself with a period of 2<sup>k</sup>-1.)

One popular way to generate a PN sequence is with a [linear feedback shift register](https://en.wikipedia.org/wiki/Linear-feedback_shift_register) (LFSR). Consider the LFSR described by the sequence 10011, which can also be described by the following block diagram:

![](/blog/content/images/2017/02/fhss-lfsr.svg)
<small><i>Figure 3: The LFSR corresponding to the generator 10011.</i></small>

In the FHSS implementation used in this experiment, the spreading code is determined from the state of the registers as shown in Figure 4. After each time instance, the values in each register "shift" as follows (for the LFSR generated by "10011"):

* r<sub>0</sub> [n+1] = r<sub>3</sub> [n]
* r<sub>1</sub> [n+1] = r<sub>0</sub> [n]
* r<sub>2</sub> [n+1] = r<sub>1</sub> [n]
* r<sub>3</sub> [n+1] = r<sub>2</sub> [n] + r<sub>3</sub> [n] 

(where the addition in the last item is an XOR operation).  Then, the "value" used for that time instance is the decimal value corresponding to the binary digits 

r<sub>3</sub> r<sub>2</sub> r<sub>1</sub> r<sub>0</sub> 

e.g. if the values are r<sub>3</sub>=1, r<sub>2</sub>=1, r<sub>1</sub>=0, r<sub>0</sub>=1, then the channel at f<sub>13</sub> will be used (1101<sub>2</sub>=13).

![](/blog/content/images/2017/02/fhss-lfsr-example-shift-3.svg)
<small><i>Figure 4: The first four values for the LFSR corresponding to the generator 10011, with initial register values 1111, would be: 15, 7, 14, 5.</i></small>


For the example above, the complete frequency hopping sequence would be:

f<sub>15</sub>, f<sub>7</sub>, f<sub>14</sub>, f<sub>5</sub>, f<sub>10</sub>, f<sub>13</sub>, f<sub>3</sub>, f<sub>6</sub>, f<sub>12</sub>, f<sub>1</sub>, f<sub>2</sub>, f<sub>4</sub>, f<sub>8</sub>, f<sub>9</sub>, f<sub>11</sub>

after which it will repeat.

## Results

The following video shows the FHSS transmission due to a PN generator with generator (1,0,0,1,1) and initial values (1,1,1,1):

<iframe width="560" height="315" src="https://www.youtube.com/embed/6qNWQxRKoss" frameborder="0" allowfullscreen></iframe>

Here's a screenshot of that hopping pattern, annotated with channel numbers:

![](/blog/content/images/2017/02/fhss-channels-1.png)

## Run my experiment

First, you will have to reserve time on an SDR testbed: either sb2, sb3, or sb7 on ORBIT. Log on with your GENI account at [http://geni.orbit-lab.org](http://geni.orbit-lab.org), then click "Control Panel" to access the schedule page.

### Load disk image onto testbed nodes

At your reserved time, open a terminal and log in to the console of the testbed that you have reserved. For example, if you have reserved sandbox 3 on ORBIT, 

```
ssh GENI-WIRELESS-USERNAME@sb3.orbit-lab.org -i /PATH/TO/KEY
```

where `GENI-WIRELESS-USERNAME` is your wireless username assigned by GENI. This is usually your regular GENI username with a `geni-` prefix, e.g. `geni-ffund`. Also specify the path to the key you have uploaded to the GENI Portal as the `/PATH/TO/KEY`.

If you are using sandbox 2 or sandbox 7, log in to sb2.orbit-lab.org or sb7.orbit-lab.org, respectively.

Then, you must load a disk image onto the testbed nodes. From the testbed console, run:

```
omf load -i gr-spread.ndz -t system:topo:all
```

This disk image has the [GNU Radio](http://gnuradio.org/) software suite, and the [ShinySDR spectrum analyzer](https://github.com/kpreid/shinysdr/), both of which we'll use for this experiment, pre-installed. 

This process can take 5-10 minutes. Don't interrupt it in middle - you'll just have to start again, and it will only take longer. 

If it's been successful, then once the process finishes running completely you should see output similar to:

```
 INFO exp:  ----------------------------- 
 INFO exp:  Imaging Process Done 
 INFO exp:  2 nodes successfully imaged - Topology saved in '/tmp/omf-pxe_slice-2014-02-04t16.38.52-05.00-topo-success.rb'
 INFO exp:  ----------------------------- 
```

Sometimes, transient errors can cause the process to fail - if you haven't successfully imaged 2 nodes, wait a few minutes and try again. 

When you've finished loading the disk image, turn on your nodes with

```
omf tell -a on -t system:topo:all
```

Wait a few minutes for your testbed nodes to turn on, then continue with the experiment.

### Set up and calibrate your receiver

Open a new terminal window, and run

```
ssh -L 8100:node1-2:8100 -L 8101:node1-2:8101 GENI-WIRELESS-USERNAME@sb3.orbit-lab.org -i /PATH/TO/KEY
```

again, using the correct `GENI-WIRELESS-USERNAME`, `/PATH/TO/KEY`, and substituting for sb3.orbit-lab.org the hostname of the console of the testbed that you have reserved.

Then, in that terminal window (which should now be logged in to your testbed console), run

```
ssh root@node1-2
```

Then, run the ShinySDR server:

```
cd ~/shinysdr
python -m shinysdr.main ~/.shiny
```

This last command should start the Shiny server, which, when it is running successfully, will say something like:

```
INFO:shinysdr:ShinySDR is ready.
INFO:shinysdr:Visit http://localhost:8100/ShinySDR/
```

In a [Google Chrome](https://www.google.com/chrome/browser/) browser window, open the URL that is shown in the Shiny server output. (http://localhost:8100/ShinySDR/).

Configure your Shiny window as follows:

<iframe width="560" height="315" src="https://www.youtube.com/embed/YT7hchUqN4U" frameborder="0" allowfullscreen></iframe>

* Click on the "hamburger" icon in the top left corner to open the menu, if it isn't already open.
* Un-select the "Frequency DB" display to hide that display if it is showing.
* Select the "Radio Config" display if it isn't showing.
* In the "Radio Config" section, set the "RF Source" to "OsmoSDR", the "Antenna" to "TX/RX", and the "Center Frequency" to 2,480,000,000 (2.48 GHz). 
* Note the "Gain" slider in the "Radio Config" section. You may have to increase the gain later if you aren't able to see the transmission in the ShinySDR window.
* Check the "Use DC Cancellation" box, but don't worry if it doesn't stay checked.
* Use the "Options" section to adjust the dynamic range and reference level of the visualization so that you can see the noise floor and there is about 60-80 dB of range.
* Click on the "hamburger" again to close the menu.

Because FHSS is highly sensitive to frequency, you will also have to calibrate your receiver against the transmitter to adjust for any frequency offset that might exist between them. (See [Why is my signal located at an offset from the expected center frequency?](https://witestlab.poly.edu/blog/why-is-my-signal-located-at-an-offset-from-the-expected-center-frequency/) for more explanation of the frequency offset phenomenon.)

Open a new terminal, and log in to the testbed console again. From the testbed console, log in to the transmitter node:

```
ssh root@node1-1
```

On the transmitter node, generate a reference signal at 2480 MHz using the following command:

```
/usr/local/lib/uhd/examples/tx_waveforms --freq 2.48e9 --rate 200e3 --ampl 0.5 --gain 0
```

While this is running, in the ShinySDR interface, adjust the "Freq.corr. (PPM)" option until you can see the 2480 MHz signal in the center of the display, at the tick mark labeled 2480 MHz:

<iframe width="560" height="315" src="https://www.youtube.com/embed/FxFXK74nstM" frameborder="0" allowfullscreen></iframe>

(If the signal already appears at 2480 MHz, there is no frequency offset and you don't have to adjust the frequency correction.)

When you are satisfied, use Ctrl+C to stop the transmitter on node1-1.

### Run the FHSS transmitter

On node1-1, download the FHSS transmitter from [GitHub](https://gist.github.com/ffund/c35be160b9e0e8fc8d743cd7cab32a27) with 

```
wget https://git.io/vDDpm -O fhss_tx.py
```

To run the FHSS transmitter for the generator "10011", on node1-1 run

```
python fhss_tx.py -f 2480e6 -r 4 -g "1,0,0,1,1"
```

where

* `-f` is used to set the carrier frequency,
* `-r` gives the number of registers to use, and
* `-g` specifies the generator for the PN sequence.

(All registers will be initialized with value of 1.)

You should observe the hopping pattern f<sub>15</sub>, f<sub>7</sub>, f<sub>14</sub>, f<sub>5</sub>, f<sub>10</sub>, f<sub>13</sub>, f<sub>3</sub>, f<sub>6</sub>, f<sub>12</sub>, f<sub>1</sub>, f<sub>2</sub>, f<sub>4</sub>, f<sub>8</sub>, f<sub>9</sub>, f<sub>11</sub>:

<iframe width="560" height="315" src="https://www.youtube.com/embed/6qNWQxRKoss" frameborder="0" allowfullscreen></iframe>

(Note that for some channels, especially those far from the center frequency, a lower-power "mirror image" of the signal may appear at the same time at its "opposite" channel (relative to the center frequency). This is not a cause for concern; the "mirror" signal can be ignored.)
 
The offset of each channel relative to the center frequency will be printed in the terminal output, e.g.:

```
Center Freq 0: -732422
Center Freq 1: -634766
Center Freq 2: -537109
Center Freq 3: -439453
Center Freq 4: -341797
Center Freq 5: -244141
Center Freq 6: -146484
Center Freq 7: -48828.1
Center Freq 8: 48828.1
Center Freq 9: 146484
Center Freq 10: 244141
Center Freq 11: 341797
Center Freq 12: 439453
Center Freq 13: 537109
Center Freq 14: 634766
Center Freq 15: 732422
```

## Notes

* The FHSS implementation used in this experiment was developed by Paul David, as described in [this GRCon '14 presentation](http://gnuradio.squarespace.com/storage/grcon14/presentations/Sep18_07_David_DSSSFHSS.pdf).
* This experiment was developed with assistance from [Ajinkya Kadam](https://ajinkyakadam.bitbucket.io/).

### Exercise

Run the frequency hopping spread spectrum transmitter with the PN code generator "11001". Take a screenshot of the ShinySDR receiver showing the complete hopping pattern (show at least 20 hops). Annotate your screenshot - add the channel numbers at the bottom, similar to [this image](https://witestlab.poly.edu/blog/content/images/2017/02/fhss-channels-1.png) (although the specific hopping pattern will be different since the generator is different!). 

List the hopping sequence for the first 20 hops observed in your screenshot.

Also, create a figure similar to [this one](https://witestlab.poly.edu/blog/content/images/2017/02/fhss-lfsr-example-shift-3.svg), showing how the FHSS transmitter determines the first four channels in the sequence for the generator "11001".

